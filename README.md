# openliberty-operator-day2
Generate dumps and traces using the Open Liberty Operator Day-2 capabilities. 

**NOTE**: These instructions assume that the Open Liberty Operator and sample Mod Resorts application are already installed on your OpenShift cluster. If this is not the case, refer to the instructions here: https://github.com/OpenShift-Z/openliberty-operator-ocpz/ to install it, and then return to this repository. 

# Steps

1. [Clone the repository locally](#1-clone-the-repository-locally) 
2. [Move into your project](#2-move-into-your-project)
3. [Create your PV and PVC](#3-create-your-pv-and-pvc)
4. [Attach Storage to your Open Liberty Application](#4-attach-storage-to-your-open-liberty-application)
5. [Generate a Dump of your Open Liberty Application](#5-generate-a-dump-of-your-open-liberty-application)
6. [Generate a Traces of your Open Liberty Application](#6-generate-a-trace-of-your-open-liberty-application)

### 1. Clone the repository locally

Clone this `git` repository on your local server and change into the new directory.

```bash
$ git clone https://github.com/mmondics/openliberty-operator-day2
Cloning into 'openliberty-operator-day2'...
remote: Enumerating objects: 21, done.
remote: Counting objects: 100% (21/21), done.
remote: Compressing objects: 100% (20/20), done.
remote: Total 21 (delta 6), reused 0 (delta 0), pack-reused 0
Unpacking objects: 100% (21/21), done.

$ cd openliberty-operator-day2/
```

### 2. Move into your project

Open Liberty dumps and traces are generated by creating Custom Resources (CRs) from the OpenLibertyDump and OpenLibertyTrace Custom Resource Definitions (CRDs) that were loaded into your cluster during the prequisite (Open Liberty Operator installation)[https://github.com/OpenShift-Z/openliberty-operator-ocpz/]. These CRs must be created in the same project where your OpenLibertyApplication CR is deployed. 

Log into OpenShift via the CLI, then change into the project containing your OpenLibertyApplication. 

**NOTE**: `<BRACKETS>` denote a variable that you should edit for your environment. Wherever you see text in `<BRACKETS>`, replace the text within the brackets and remove the brackets themselves e.g. `<OPENSHIFT_PROJECT>` will become something like `openliberty-project`. 

```bash
$ oc login --server=<OPENSHIFT_API_URL> # replace with your OpenShift cluster API address. You can find it on the overview page in the OpenShift console.
$ oc project <OPENSHIFT_PROJECT>

```

### 3. Create your PV and PVC

The Open Liberty Operator's Day-2 operations require [storage for serviceability](https://github.com/OpenLiberty/open-liberty-operator/blob/master/doc/user-guide.adoc#storage-for-serviceability). Included in this repository are example YAML files you can use to quickly create a Persistent Volume (PV) and Persistent Volume Claim (PVC) for your Open Liberty application to store its dumps and traces. 

Edit the `pv-ol-day2.yaml` and `pvc-ol-day2.yaml` files, replacing values for `<HOSTNAME>`, `<HOST_PATH>`, and `<OPENSHIFT_PROJECT>` to reflect your OpenShift and NFS environments. 

1. `<HOSTNAME>` should be the server address hosting your NFS storage. 
2. `<HOST_PATH>` should be the path on your server where you want the dumps and traces to be stored (e.g. `/srv/nfs/openshift/ocpenv1/ol-day2`). 
3. `<OPENSHIFT_PROJECT>` should be the name of the project where your Open Liberty application is already deployed. 

With the two YAML files edited, run the following commands to create the PV and PVC in your OCP cluster. 

```bash
$ oc create -f pv-ol-day2.yaml 
persistentvolume/pv-ol-day2 created

$ oc create -f pvc-ol-day2.yaml 
persistentvolumeclaim/pvc-ol-day2 created
```

If properly created, your PVC should bind to your PV almost instantly. 

Run the following command to see if your PVC is bound to the PV.

```bash 
$ oc get pvc
NAME          STATUS   VOLUME       CAPACITY   ACCESS MODES   STORAGECLASS          AGE
pvc-ol-day2   Bound    pv-ol-day2   2Gi        RWX            managed-nfs-storage   3m22s
```

### 4. Attach Storage to your Open Liberty Application

Since your `OpenLibertyApplication` is already deployed, you can simply attach your newly created storage to it. There are multiple ways to do this, but the simplest way to do so is with an `oc patch` command. 

Run the following commands to find the name of your OpenLibertyApplication and patch it to include your PVC name. 

```bash
$ oc get olapp
NAME     IMAGE                                                                                            EXPOSED   RECONCILED   AGE
appmod   image-registry.openshift-image-registry.svc:5000/zats-test-05-project/app-modernization:v1.0.0   true      True         5d

$ oc patch openlibertyapplication appmod -p '{"spec":{"serviceability":{"volumeClaimName":"pvc-ol-day2"}}}' --type=merge
openlibertyapplication.openliberty.io/appmod patched
```

**NOTE**: If you modified your OpenLibertyApplication or PVC names, make sure to reflect the changes in the commands above. 

This change will require your application pod to restart. Check that it's back up and running with the following command.

```bash
$ oc get pod
NAME                      READY   STATUS    RESTARTS   AGE
<POD_NAME>                1/1     Running   0          3m5s
```

**NOTE**: Take note of your `<POD_NAME>`, as you will need it in the next step. 

### 5. Generate a Dump of your Open Liberty Application

You will generate a dump of your application by creating a OpenLibertyDump CR. This repository includes a template CR which you can edit to reflect your OCP cluster. 

Edit the `ol-dump.yaml` file, replacing values for `<OPENSHIFT_PROJECT>` and `<POD_NAME>` to reflect your project and pod names. 

1. `<OPENSHIFT_PROJECT>` should be the name of the project where your Open Liberty application is deployed.
2. `<POD_NAME>` should be name of the pod returned in the last step. 

With the YAML file edited, run the following command to create the OpenLibertyDump CR. 

```bash
$ oc create -f ol-dump.yaml 
openlibertydump.openliberty.io/ol-dump created
```

Your dump has been created and should now either be in process or completed. Check the status of your dump with the following command. 
```bash
$ oc get oldump -o wide
NAME           STARTED   REASON   MESSAGE   COMPLETED   REASON   MESSAGE   DUMP FILE
ol-dump        True                         True                           /serviceability/zats-test-05-project/appmod-864b8fb98f-ksq9g/2020-10-01_18:33:49.zip
```

When your dump has completed, you can find it by navigating to `<HOSTNAME>`/`<HOST_PATH>` that you specified in Step 3. Here you will find a new sub-directory named `/<OPENSHIFT_PROJECT>/<POD_NAME>` that contains a .zip file of your generated dump. 

```bash
$ tree
.
`-- <OPENSHIFT_PROJECT>
    `-- <POD_NAME>
        `-- 2020-10-01_18:33:49.zip
```

### 6. Generate a Trace of your Open Liberty Application

Similar to dumps, you will generate a trace of your application by creating a OpenLibertyTrace CR. This repository includes a template CR which you can edit to reflect your OCP cluster. 

As you did in Step 5, Edit the `ol-trace.yaml` file, replacing values for `<OPENSHIFT_PROJECT>` and `<POD_NAME>` to reflect your project and pod names. 

With the YAML file edited, run the following command to create the OpenLibertyTrace CR. 

```bash
$ oc create -f ol-trace.yaml 
openlibertytrace.openliberty.io/ol-trace created
```

Your application is now being traced. View the trace with the following command. 
```bash
$ oc get oltrace -o wide
NAME            PODNAME                   TRACING   REASON   MESSAGE
ol-trace        appmod-56fbf7b58d-l4mkn   True       
```

In the same path where your dump file is located, you will now find two new log files: `messages.log` and `trace.log`. 
```bash
$ ls -l
total 6376
-rw-rw---- 1 1000930000 root 6501975 Oct  1 18:34 2020-10-01_18:33:49.zip
-rw-r----- 1 1000930000 root     723 Oct  1 19:56 messages.log
-rw-r----- 1 1000930000 root   18309 Oct  1 20:08 trace.log
```
These files can be viewed using cat, vim, or whichever tool you prefer. 

Once the trace has started, it can be stopped by setting a `disable` parameter to `true`. Deleting the OpenLibertyTrace CR will also stop the tracing. Changing the `<POD_NAME>` (e.g. if the pod is terimanated and restarted) will first stop the tracing on the old Pod before enabling traces on the new Pod.
